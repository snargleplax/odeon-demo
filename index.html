<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Odeon - Graph Theatre</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            color: #e94560;
            margin-bottom: 5px;
        }
        #loading {
            color: #888;
            margin: 20px;
        }
        #stage-container {
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #canvas {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.0;
            white-space: pre;
            border: 2px solid #63b3ed;
            border-radius: 8px;
            padding: 10px;
            background: #0d0d1a;
            height: 500px;
            width: 600px;
            overflow: auto;
        }
        #info-panel {
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #location {
            color: #e94560;
            font-size: 18px;
        }
        #characters {
            color: #4ecdc4;
            font-style: italic;
        }
        #actions {
            margin-top: 15px;
            text-align: left;
            height: 120px;
        }
        #actions h3 {
            color: #888;
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .action-item {
            color: #aaa;
            padding: 4px 0;
            font-size: 14px;
        }
        #controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .control-btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
        }
        .control-btn:hover {
            background: #ff6b6b;
        }
        .control-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        #footer {
            margin-top: 30px;
            color: #555;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ODEON</h1>
    <div id="loading">Loading WASM...</div>
    <div id="stage-container">
        <div id="canvas"></div>
        <div id="info-panel">
            <div id="location"></div>
            <div id="characters"></div>
        </div>
        <div id="actions">
            <h3>Available Actions:</h3>
            <div id="action-list"></div>
        </div>
        <div id="controls">
            <button id="act-btn" class="control-btn" onclick="act()">Act</button>
            <button id="new-story" class="control-btn" onclick="startNewStory()">New Story</button>
        </div>
    </div>
    <div id="footer"></div>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        let currentActions = [];

        function ansiToHex(ansi) {
            // Basic 256-color ANSI to hex conversion
            if (!ansi) return null;
            const n = parseInt(ansi, 10);
            if (isNaN(n)) return null;

            // Standard colors (0-15)
            const standard = [
                '#000000', '#800000', '#008000', '#808000', '#000080', '#800080', '#008080', '#c0c0c0',
                '#808080', '#ff0000', '#00ff00', '#ffff00', '#0000ff', '#ff00ff', '#00ffff', '#ffffff'
            ];
            if (n < 16) return standard[n];

            // 216-color cube (16-231)
            if (n < 232) {
                const idx = n - 16;
                const r = Math.floor(idx / 36) * 51;
                const g = Math.floor((idx % 36) / 6) * 51;
                const b = (idx % 6) * 51;
                return `rgb(${r},${g},${b})`;
            }

            // Grayscale (232-255)
            const gray = (n - 232) * 10 + 8;
            return `rgb(${gray},${gray},${gray})`;
        }

        function renderFrame(frame) {
            if (frame.error) {
                document.getElementById('canvas').textContent = 'Error: ' + frame.error;
                return;
            }

            // Render canvas with colors
            let html = '';
            for (const row of frame.cells) {
                for (const cell of row) {
                    const fg = ansiToHex(cell.fg);
                    const bg = ansiToHex(cell.bg);
                    let style = '';
                    if (fg) style += `color:${fg};`;
                    if (bg) style += `background:${bg};`;

                    const char = cell.char || ' ';
                    const escaped = char.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    if (style) {
                        html += `<span style="${style}">${escaped}</span>`;
                    } else {
                        html += escaped;
                    }
                }
                html += '\n';
            }
            document.getElementById('canvas').innerHTML = html;

            // Update location
            document.getElementById('location').textContent = frame.location || '';

            // Update characters
            if (frame.characters && frame.characters.length > 0) {
                document.getElementById('characters').textContent = frame.characters.join(', ') + ' is here';
            } else {
                document.getElementById('characters').textContent = '';
            }

            // Update actions (static display)
            currentActions = frame.actions || [];
            const actionList = document.getElementById('action-list');
            actionList.innerHTML = '';
            if (currentActions.length > 0) {
                for (const action of currentActions) {
                    const item = document.createElement('div');
                    item.className = 'action-item';
                    item.textContent = 'â€¢ ' + action.label;
                    actionList.appendChild(item);
                }
            } else {
                actionList.innerHTML = '<div style="color:#888">(none available)</div>';
            }

            // Enable/disable Act button based on available actions
            document.getElementById('act-btn').disabled = currentActions.length === 0;
        }

        let animating = false;

        function act() {
            if (currentActions.length === 0 || animating) return;

            // Pick a random action
            const randomIndex = Math.floor(Math.random() * currentActions.length);
            const action = currentActions[randomIndex];

            // Start the move and get path length
            const moveResult = JSON.parse(startMove(action.index));
            if (moveResult.error) {
                console.error(moveResult.error);
                return;
            }

            if (moveResult.pathLength === 0) {
                // No path, already teleported
                renderFrame(JSON.parse(finishMove()));
                return;
            }

            // Animate through the path
            animating = true;
            document.getElementById('act-btn').disabled = true;
            let step = 0;
            const pathLength = moveResult.pathLength;

            function animateStep() {
                if (step < pathLength) {
                    const frame = JSON.parse(animStep(step));
                    renderFrame(frame);
                    step++;
                    setTimeout(animateStep, 100);
                } else {
                    // Animation complete
                    const frame = JSON.parse(finishMove());
                    renderFrame(frame);
                    animating = false;
                }
            }

            animateStep();
        }

        function startNewStory() {
            const seed = Date.now();
            const result = newGame(seed);
            renderFrame(JSON.parse(result));
        }

        WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stage-container').style.display = 'flex';

            // Start a new story
            startNewStory();

            // Display build info
            const buildInfoJson = getBuildInfo();
            const buildInfo = JSON.parse(buildInfoJson);
            const shortSHA = buildInfo.gitSHA.substring(0, 7);
            document.getElementById('footer').textContent = shortSHA;
        }).catch(err => {
            document.getElementById('loading').textContent = 'Error loading WASM: ' + err;
        });
    </script>
</body>
</html>
